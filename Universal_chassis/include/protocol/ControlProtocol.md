# 小车控制协议说明

该协议定义了与ESP32小车控制系统进行交互的标准格式。系统采用JSON格式进行数据传输，支持下发小车运动控制命令与发布小车状态信息。该协议可通过MQTT或USB虚拟串口实现。

---

## 1. 控制命令格式

所有控制命令均使用JSON格式传输，数据格式及各参数说明如下：

### 1.1 速度模式控制指令

用于设置小车以指定速度运动。

**JSON 示例**:
```json
{
  "command": "speed",
  "vx": 0.5,              // X 方向线速度（单位：m/s），正值表示前进，负值表示后退
  "vy": 0.0,              // Y 方向线速度（单位：m/s）
  "omega": 0.1,           // 旋转角速度（单位：rad/s），正值表示逆时针旋转
  "acceleration": 10.0,   // 加速度（可选，缺省值：10.0）
  "subdivision": 256      // 细分数（可选，缺省值：256）
}
```

### 1.2 位置模式控制指令

用于控制小车移动固定距离，并可同时旋转指定角度。

**JSON 示例**:
```json
{
  "command": "move",
  "dx": 1.0,              // X 方向位移（单位：m），正值表示前进
  "dy": 0.0,              // Y 方向位移（单位：m）
  "dtheta": 0.0,          // 旋转角度（单位：rad），正值表示逆时针旋转
  "speed": 0.5,           // 运动速度（单位：m/s，可选，缺省值：1.0）
  "acceleration": 10.0,   // 加速度（可选，缺省值：10.0）
  "subdivision": 256      // 细分数（可选，缺省值：256）
}
```

### 1.3 紧急停止指令

用于立即停止小车运动。

**JSON 示例**:
```json
{
  "command": "stop"
}
```

### 1.4 获取状态指令

请求系统立即返回当前小车状态信息。

**JSON 示例**:
```json
{
  "command": "get_status"
}
```

### 1.5 设置状态发布间隔指令

用于设置系统自动发布状态的时间间隔。

**JSON 示例**:
```json
{
  "command": "set_interval",
  "interval": 1000        // 状态发布间隔（毫秒），设置为0表示禁用状态发布
}
```

### 1.6 设置WiFi连接指令

用于动态配置WiFi连接参数，无需重新编译代码。

**JSON 示例**:
```json
{
  "command": "set_wifi",
  "ssid": "MyWiFi",       // WiFi网络名称
  "password": "MyPass"    // WiFi密码
}
```

---

## 2. 状态信息格式

系统会定期或根据请求发布小车当前状态信息，数据格式如下：

**JSON 示例**:
```json
{
  "vx": 0.0,              // 当前小车 X 方向线速度（m/s）
  "vy": 0.0,              // 当前小车 Y 方向线速度（m/s）
  "omega": 0.0,           // 当前小车旋转角速度（rad/s）
  "wheelSpeeds": [        // 各个轮子的速度反馈（单位由系统定义，例如 RPM）
    0,
    0,
    0,
    0
  ]
}
```

---

## 3. 通用注意事项

- **格式严格**：所有JSON数据需要严格遵循上述格式，否则系统可能无法正确解析并执行命令。
- **缺省值**：若不指定`acceleration`和`subdivision`参数，系统将使用默认配置值。
- **细分设置**：`subdivision`参数可用于调整电机细分，影响控制精度和功耗。较高的细分值提供更平滑的运动但可能增加处理负担。
- **WiFi设置**：通过设置命令可以动态更改WiFi连接，无需重新编译代码。
- **状态发布**：系统会按照设定的时间间隔发布状态信息。可以通过设置命令修改发布间隔，设置为0可以禁用状态发布。

---

以上是通用控制协议的核心部分，具体传输方式（MQTT或USB）的详细说明请参考各自的协议文档。 
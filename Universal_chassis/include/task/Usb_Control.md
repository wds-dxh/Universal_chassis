# USB 控制协议说明

该协议用于通过 USB 虚拟串口与 ESP32 小车控制系统进行交互。协议采用 JSON 格式进行数据传输，实现下发控制命令以及状态请求和自动状态发布。

---

## 1. 连接说明

- ESP32 通过 USB 虚拟串口向主机（PC 或树莓派）提供通信接口。
- 主机通过打开对应的虚拟串口发送 JSON 格式的数据来控制小车动作，并接收状态反馈数据。

---

## 2. 控制命令及数据模式

虽然 USB 传输没有 MQTT 中的主题概念，但协议定义了不同类型的指令和状态数据格式：

- **控制命令**：主机下发命令给 ESP32，包括运动控制指令、状态请求以及自动状态发布控制命令。
- **状态数据**：ESP32 在接收到状态请求时，或按照设定的自动发布间隔，通过 USB 向主机发送当前小车状态信息。

---

## 3. 控制命令格式

所有下发命令均采用 JSON 格式，数据格式及各参数说明如下：

### 3.1 速度模式控制指令

用于设置小车以指定速度运动，给出运动持续时间后自动停止。

**JSON 示例**:
```json
{
  "command": "speed",
  "vx": 0.5,              // X 方向线速度（单位：m/s），正值表示前进，负值表示后退
  "vy": 0.0,              // Y 方向线速度（单位：m/s）
  "omega": 0.1,           // 旋转角速度（单位：rad/s），正值表示逆时针旋转
  "duration": 5000,       // 运动持续时间（毫秒）
  "acceleration": 10.0    // 加速度（可选，缺省值：10.0）
}
```

### 3.2 位置模式控制指令

用于控制小车移动固定距离，并可同时旋转指定角度。

**JSON 示例**:
```json
{
  "command": "move",
  "dx": 1.0,              // X 方向位移（单位：m），正值表示前进
  "dy": 0.0,              // Y 方向位移（单位：m）
  "dtheta": 0.0,          // 旋转角度（单位：rad），正值表示逆时针旋转
  "acceleration": 10.0,   // 加速度（可选，缺省值：10.0）
  "subdivision": 256      // 细分数（可选，缺省值：256）
}
```

### 3.3 紧急停止指令

用于立即停止小车运动。

**JSON 示例**:
```json
{
  "command": "stop"
}
```

### 3.4 状态请求指令

主机使用该命令请求 ESP32 立即返回当前小车状态信息。

**JSON 示例**:
```json
{
  "command": "status"
}
```

### 3.5 自动状态发布控制指令

用于设置 ESP32 自动发布状态数据的时间间隔（单位：毫秒）。设置 `"interval": 0` 表示关闭自动状态发布。

**JSON 示例**:
```json
{
  "command": "auto",
  "interval": 1000   // 自动发布状态的时间间隔（毫秒）
}
```

---

## 4. 状态数据格式

ESP32 控制系统通过 USB 虚拟串口会发送 JSON 格式的状态数据，其格式如下：

**JSON 示例**:
```json
{
  "vx": 0.0,              // 当前小车 X 方向线速度（m/s）
  "vy": 0.0,              // 当前小车 Y 方向线速度（m/s）
  "omega": 0.0,           // 当前小车旋转角速度（rad/s）
  "wheelSpeeds": [        // 四个轮子的速度反馈（例如单位 RPM）
    0,
    0,
    0,
    0
  ]
}
```

---

## 5. 注意事项

- **格式严格**：所有发送的 JSON 数据必须严格遵循上述格式，否则 ESP32 可能无法正确解析并执行命令。
- **自动停止**：对于 `"speed"` 命令，ESP32 在运动持续时间结束后将自动停止。如需紧急停止，请下发 `"stop"` 命令。
- **自动状态发布**：通过 `"auto"` 命令可以设置 ESP32 自动发布状态的时间间隔，便于主机实时监控小车状态。设置 `"interval": 0` 可以关闭此功能。
- **互斥使用**：在启用 USB 控制模式时，请确保禁用其它无线通信控制方式（如 MQTT）。

---

以上即为 USB 控制协议的全部说明，请主机端按照该协议格式下发控制命令，并处理接收到的状态数据。

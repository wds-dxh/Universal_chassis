# MQTT 控制协议说明

该协议用于通过 MQTT 与 ESP32 小车控制系统进行交互。系统采用 JSON 格式的数据传输，支持下发小车运动控制命令与发布小车状态信息。

---

## 1. MQTT 连接参数

- **Broker 地址**: `47.108.223.146`
- **端口**: `1883`
- **用户名**: `emqx_u`
- **密码**: `public`

---

## 2. MQTT 主题

- **控制主题**: `CarControl`  
  外部系统下发控制命令到此主题，ESP32 订阅此主题。

- **状态主题**: `CarStatus`  
  ESP32 定期发布小车当前状态到此主题，外部系统可订阅监控状态。

---

## 3. 控制命令格式

所有控制命令均使用 JSON 格式传输，数据格式及各参数说明如下：

### 3.1 速度模式控制指令

用于设置小车以指定速度运动，运动结束后系统会自动停止电机。

**JSON 示例**:
```json
{
  "command": "speed",
  "vx": 0.5,              // X 方向线速度（单位：m/s），正值前进，负值后退
  "vy": 0.0,              // Y 方向线速度（单位：m/s）
  "omega": 0.1,           // 旋转角速度（单位：rad/s），正值表示逆时针旋转
  "acceleration": 10.0    // 加速度档位（可选，缺省值：10.0）
}
```

### 3.2 位置模式控制指令

用于控制小车移动固定距离，并可同时旋转指定角度。

**JSON 示例**:
```json
{
  "command": "move",
  "dx": 1.0,              // X 方向位移（单位：m），正值表示前进
  "dy": 0.0,              // Y 方向位移（单位：m）
  "dtheta": 0.0,          // 旋转角度（单位：rad），正值表示逆时针旋转
  "acceleration": 10.0,   // 加速度档位（可选，缺省值：10.0）
  "subdivision": 256      // 细分数（可选，缺省值：256）
}
```

### 3.3 紧急停止指令

用于立即停止所有小车运动。

**JSON 示例**:
```json
{
  "command": "stop"
}
```

---

## 4. 状态信息格式

ESP32 控制系统会定期将当前小车状态发布到 MQTT 状态主题中，数据格式参考如下：

**JSON 示例**:
```json
{
  "vx": 0.0,              // 当前小车 X 方向线速度（m/s）
  "vy": 0.0,              // 当前小车 Y 方向线速度（m/s）
  "omega": 0.0,           // 当前小车旋转角速度（rad/s）
  "wheelSpeeds": [        // 各个轮子的速度反馈（单位由系统定义，例如 RPM）
    0,
    0,
    0,
    0
  ]
}
```

---

## 5. 注意事项

- **格式严格**：发布到 `CarControl` 主题的 JSON 数据需要严格遵循上述格式，否则 ESP32 可能无法正确解析并执行命令。
- **缺省值**：若不指定 `acceleration` 和 `subdivision` 参数，系统将使用默认配置值。
- **自动停止**：对速度模式的控制命令来说，`duration` 参数指定了运动时间，到期后系统会自动调用停止命令；如需紧急停止，请下发 `"stop"` 指令。
- **状态发布**：ESP32 会定期发布状态信息到 `CarStatus` 主题，方便外部系统实时监控小车状态。

---

以上就是 MQTT 控制协议的全部说明，供外部系统以此格式下发控制命令或订阅状态信息。

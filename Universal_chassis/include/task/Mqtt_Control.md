# MQTT 控制协议说明

本文档描述了通过MQTT与ESP32小车控制系统进行交互的方法。控制命令和状态信息的格式遵循[通用控制协议](../protocol/ControlProtocol.md)。

---

## 1. MQTT 连接参数

- **Broker 地址**: `47.108.223.146`
- **端口**: `1883`
- **用户名**: `emqx_u`
- **密码**: `public`

---

## 2. MQTT 主题

- **控制主题**: `CarControl_001`  
  外部系统下发控制命令到此主题，ESP32 订阅此主题。

- **状态主题**: `CarStatus_001`  
  ESP32 定期发布小车当前状态到此主题，外部系统可订阅监控状态。

---

## 3. MQTT 特有说明

- **连接恢复**: 当WiFi或MQTT连接断开时，系统会自动尝试重新连接。
- **QoS级别**: 控制命令和状态信息均使用QoS 0发布，以确保实时性。
- **保留消息**: 状态信息不设置为保留消息，以避免新客户端连接时收到过时的状态。
- **并发控制**: MQTT控制与USB控制可同时使用，通过控制管理器协调，避免资源冲突。
- **设备ID**: 主题名称中包含设备ID（如`001`），支持多设备部署。

---

## 4. 使用示例

### 发布控制命令
使用MQTT客户端向`CarControl_001`主题发布JSON格式的控制命令：

```json
{
  "command": "speed",
  "vx": 0.5,
  "vy": 0.0,
  "omega": 0.0,
  "subdivision": 256
}
```

或获取当前状态：

```json
{
  "command": "get_status"
}
```

### 订阅状态信息
使用MQTT客户端订阅`CarStatus_001`主题以接收小车状态信息。

---

有关控制命令和状态信息的详细格式，请参考[通用控制协议](../protocol/ControlProtocol.md)文档。
